<#setting url_escaping_charset=encoding>

<#-- Encode facet queries -->
<#macro EncodeFQ list_fq>
<#assign encoded_facets_queries = ""> 
<#list list_fq as facet>
<#assign encoded_facets_queries = encoded_facets_queries+"&fq="+facet?url> 
</#list>
${encoded_facets_queries}</#macro>

<div class="row">
<#-- facets -->
<div class="col-sm-3 well" >

    <#-- Historique -->
    <div id="histoique" class="portlet -lutece-border-radius append-bottom">
        <table>
            <th>
                #i18n{search.solr.display.result.raffinement.label}
            </th>
            <#list historique as fh>
            <tr>
                <td>
                    <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}${fh.query}">${fh.name}</a>
                </td>
            </tr>
            </#list>
            <tr>
                <td>
                    <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}">#i18n{search.solr.display.result.raffinement.clear}</a>
                </td>
            </tr>
        </table>
    </div>

    <#-- facet refining -->
    <div id="facets" class="portlet -lutece-border-radius append-bottom">
        <#-- facets field -->
        <#if facets??><#-- empty or null when no connection to server -->
        <#list facets as facet>
        <#if facet.values??>
        <#-- when there is no result, facet is not null, but facet.values is -->
        <table>
            <th>
                ${solr_fields[facet.name].label}
            </th>
            <tr>
                <td>
                    <ul>
                        <#list facet.values as count>
                        <li>
                            <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}&facetlabel=${count.name}&facetname=${facet.name}&fq=${facet.name}:${count.name?url}<@EncodeFQ  facets_list/>">${count.name}(${count.count})</a>
                        </li>
                        </#list>
                    </ul>
                </td>
            </tr>
        </table>
        </#if>
        </#list>
        </#if>

        <#-- facets date refining -->
        <#if facets_date??>
        <#list facets_date as field>
        <#if field.values??>
        <#-- when there is no result, facet is not null, but facet.values is -->
        <table>
            <th>
                ${solr_fields[field.name].label}
            </th>
            <tr>
                <td>
                    <ul>
                        <#list field.values as count>
                        <#if count.count != 0>
                        <li>
                            <#assign toDate = "${count.name}"?datetime("yyyy-MM-dd'T'HH:mm:ss'Z'")>
                            <#assign daterange = "${field.name}:[${count.name} TO ${count.name}${facetDateGap}]"?url>
                            <#assign toString = "${toDate?string('yyyy')}">
                            <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}&facetlabel=${toString}&facetname=${field.name}&fq=${daterange}<@EncodeFQ  facets_list/>">${toString}(${count.count})</a>
                        </li>
                        </#if>
                        </#list>
                    </ul>
                </td>
            </tr>
        </table>
        </#if>
        </#list>
        </#if>	
    </div>

    <#-- facets Intersection -->
    <#if facet_tree??>
    <div id="intersection" class="portlet -lutece-border-radius append-bottom">
        <#list facet_tree?keys as key>
        <table>
            <th>
                <#assign field1= "${key}"?split(",")[0] >
                <#assign field2= "${key}"?split(",")[1] >
                ${solr_fields[field1].label} / ${solr_fields[field2].label}
            </th>
            <#list facet_tree[key] as facet>
            <#if facet.values??>
            <#-- when there is no result, facet is not null, but facet.values is -->
            <tr>
                <td>
                    <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}&fq=${field1}:${facet.name?url}<@EncodeFQ  facets_list/>">${facet.name}</a>
                </td>
            </tr>
            <tr>
                <td>
                    <ul>
                        <#list facet.values as count>
                        <li>
                            <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}&query=${query?url}&fq=${field1}:${facet.name?url}&fq=${field2}:${count.name?url}<@EncodeFQ  facets_list/>">${count.name}(${count.count})</a>
                        </li>
                        </#list>
                    </ul>
                </td>
            </tr>
            </#if>
            </#list>
        </table>
        </#list>
    </div>
    </#if>

    <#-- sort order -->
    <#if sort_list??>
    <div id="tri" class="portlet -lutece-border-radius append-bottom">
        <table>
            <th>
                #i18n{search.solr.display.result.sort}
            </th>
            <#list sort_list as field>
            <#if field.enableSort>
            <tr>
                <td>
                    <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&query=${query?url}<@EncodeFQ  facets_list/>&sort_name=${field.solrName}&sort_order=desc">${field.label} desc</a>
                </td>
            </tr>
            <tr>
                <td>
                    <a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&query=${query?url}<@EncodeFQ  facets_list/>&sort_name=${field.solrName}&sort_order=asc">${field.label} asc</a>
                </td>
            </tr>
            </#if>
            </#list>
        </table>
    </div>
    </#if>
</div>

<#-- results -->
<div id="resultList" class="col-sm-6">
    <#-- new Search -->
    <div id="newSearch" class="append-bottom ">
	<div class="well">
		<form name="search" method="post" action="${fullUrl}">
		    <div class="hide">
		        <input type="hidden" name="page" value="search-solr" />
		        <input type="hidden" name="sort_name" value="${sort_name!}" />
		        <input type="hidden" name="sort_order" value="${sort_order!}" />
		        <#if facets_list??>
		        <#list facets_list as facet>
		        <input type="hidden" name="fq" value="${facet}" />
		        </#list>
		        </#if>

		    </div>
		    <div style="text-align:center;">
		        <input type="text" name="query" size="35" value="${query?if_exists}" id="solr" /> 
			<span>
		        	<input type="submit" value="#i18n{portal.search.search_results.buttonSearch}" />
			</span>
		    </div>
	    </div>
            <div>
                <#-- Number of documents per page selector -->
                #i18n{portal.search.search_results.labelNbDocsPerPage}: 
                <@NbItemsPerPageSelectorCombo nb_items_per_page?string />
            </div>
        </form>
    </div>
    <div id="resultList2" class="portlet -lutece-border-radius">
        <legend>#i18n{portal.search.search_results.title}</legend>
        <#if error?has_content>
        <div class="error">${error}</div>
        </#if>
        <div>#i18n{portal.search.search_results.labelResultsCount} : <strong>${paginator.itemsCount}</strong></div>
        

        <#-- spellChecker -->
        <#if suggestion?has_content>
        <div id="spellchecker">
            <#assign newQuery="" >
            #i18n{search.solr.display.result.spellchecker}<a href="${fullUrl}?page=search-solr&items_per_page=${nb_items_per_page}&query=${suggestion?trim?url}<@EncodeFQ  facets_list/>">${suggestion?trim}</a>	
        </div>
        </#if>

        <div>&nbsp;</div>
        <div id="pagination" class="pagination">
            <p>
                <@pagination paginator=paginator />
            </p>
        </div>

        <div id="resultItems" class="">
            <div>
                <#list results_list as result>
                <div id="item" >
                    <!-- <img src="document?id=${result.id}&id_attribute=79" style="float:left; margin-right:12px"/> -->
                    <div style="font-weight:bold; font-size:1.2em"><a href="${result.url}&terms=${query?url}&items_per_page=${nb_items_per_page}&sort_name=${sort_name!}&sort_order=${sort_order!}<@EncodeFQ  facets_list/>">${result.title}</a></div>

                    <#if result.summary??>${result.summary}</#if>
                    <#if result.highlight??>
                    <#-- get a extract from the "content" field where there is one (or more) of the searched words -->
                    <#if result.highlight.map["content"]??>
                    #i18n{search.solr.display.result.summary.extract} : 
                    <#list result.highlight.map["content"] as extrait>
                    ${extrait}
                    </#list>
                    </#if>
                    </#if>
                    <br />
                    <div style="text-align:right; font-size:0.8em;" ><#if result.date?has_content>${result.date?date}</#if></div>
                </div>
		<hr/>
                </#list>
            </div>
        </div>
    </div>
    <div>#i18n{portal.search.search_results.labelResultsRange} : <strong>${paginator.rangeMin} - ${paginator.rangeMax}</strong></div>
</div>
</div>
<#-- Freemarker macros -->

<#-- Number of items per page selector - Combo Box implementation -->
<#macro NbItemsPerPageSelectorCombo nb_items_per_page>
<select name="items_per_page">
    <#list [ "10" , "20" , "50" , "100" ] as nb>
    <#if nb_items_per_page = nb >
    <option selected="selected" value="${nb}">${nb}</option>
    <#else>
    <option value="${nb}">${nb}</option>
    </#if>
    </#list>
</select>
</#macro>

<#-- Number of items per page selector - Radio List implementation -->
<#macro NbItemsPerPageSelectorRadioList nb_items_per_page>
<#list [ "5" , "10" , "20" , "50" ] as nb>
<#if nb = nb_items_per_page > 
<input value="${nb}" id="items_per_page${nb}" name="items_per_page" class="radio" type="radio" checked /><label for="items_per_page${nb}">${nb}</label>
<#else>
<input value="${nb}" id="items_per_page${nb}" name="items_per_page" class="radio" type="radio" /><label for="items_per_page${nb}">${nb}</label>
</#if>
</#list>
</#macro>

<script>
    $(function() {

        function formatForDisplay(doc) {
            return doc.title;
        }

        $('#solr').autocomplete({
			source: function(request, response) {
				$.ajax({
					url: '@base_url@solrSuggest?',
					dataType: 'jsonp',
					minLength: 3,
					data: {
						q: request.term,
					},
					success: function(data) {
					var formattedResponse = $.map(data.response.docs, function(item) {
						return {
							label: item.title,
							value: item.title,
                        };
					});
                    response(formattedResponse);
					}
                });
            },
        });
    });
</script>